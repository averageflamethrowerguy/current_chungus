// TODO -- copy most of the logic from pipe